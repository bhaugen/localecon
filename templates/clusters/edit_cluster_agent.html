{% extends "base.html" %}

{% load humanize %}

{% block title %}
     Edit Agent {{ agent }}
{% endblock %}

{% block extra_head %}

<style>

body {font-size:90%}
h1 {font-size:2.25em}
h2 {font-size:1.6875em}
p {font-size:0.7875em}
	
</style>

{% endblock %}

{% block content %}

<div class="agents">

{% include "clusters/_cluster_nav.html" %}

<h3>Edit Agent {{ agent }} in Cluster {{ cluster }}</h3>

<div style="float:left;">
<table>
	<tr>
		<th style="text-align: left; font-size: 110%; padding-top: 1em; " colspan="3" ><b>Agent:</b> {{ agent.name }}</th>
	</tr>
	<form action="{% url inline_new_agent_function cluster_id=cluster.id agent_id=agent.id %}" method="POST">{% csrf_token %}
	<tr>
		<th style="text-align: right;" >New Function:</th>
		<td>{{ new_function_form.name }}</td>
		<td><input type="submit" name="submit" value="Add" /></td>
		<td>&nbsp;</td>
	</tr>
	{% if cluster_funs %}	
		{% for fun in cluster_funs %}
			<tr>
				<td style="padding-top: .5em; text-align: left;" colspan="3" > <b>Function:</b> {{ fun.function.name }}</td>

			</tr>

		</form>
			<tr>
				<th>Function Resources:</th>
				<th>Resource</th>
				<th>Quantity</th>
				<th style="text-align: right;" >Value</th>
			</tr>
			{% if fun.rsrcs %}
			{% for res in fun.rsrcs %}
				<tr style="color: grey;" >
					{% comment %}
					<td style="text-align: right; background: #EAF2D3;" >{{ fun.function.name }}</td>
					{% endcomment %}
					<td>&nbsp;</td>
					<td style="background: #EAF2D3;" > {{ res.role }} {{ res.resource_type }}</td>
					<td style="text-align: right; background: #EAF2D3;" >{{ res.quantity|intcomma }}</td>
					<td style="text-align: right; background: #EAF2D3;" >{{ res.value|intcomma }}</td>
				</tr>
				{% for agent_res in res.agent_resource_list %}
					<tr>
						<td style="text-align: right;" >{{ agent.name }} as {{ agent_res.agent_function.function.name }}</td>
						<td>{{ agent_res.role }} {{ agent_res.resource_type }} </td>
						{% comment %}
						<td style="text-align: right;" >
							{{ agent_res.quantity|intcomma }}
						</td>
						<td style="text-align: right;" >
							{{ agent_res.value|intcomma }}
						</td>
						{% endcomment %}
						<td style="text-align: right; ">
								<input class="quantity" id="{{ agent_res.id }}" type="text" size="7" value="{{ agent_res.quantity }}" />
							</td>
							<td style="text-align: right; ">
								<input class="value" id="{{ agent_res.id }}" type="text" size="7" value="{{ agent_res.value }}" />
							</td>
							<td>
								<form style="display: inline;" action="{% url delete_agent_function_resource id=agent_res.id %}" method="POST">
									{% csrf_token %}
									<input type="submit" value="Del" />
								</form>
							</td>
					</tr>
				{% endfor %}
				<tr>
					<td style="text-align: right; font-weight:bold;" >{{ agent.name }} as {{ res.function.name }} </td>
					<form action="{% url inline_agent_resource cluster_id=cluster.id agent_id=agent.id parent_id=res.resource_type.id %}" method="POST">
						{% csrf_token %}
						{{ res.agent_resource_form.agent_function_id }}
						<td>
							{{ res.agent_resource_form.role }}&nbsp;
							{{ res.agent_resource_form.name }}
						</td>					
						<td>{{ res.agent_resource_form.quantity }}</td>
						<td>{{ res.agent_resource_form.value }}</td>
						<td><input type="submit" name="submit" value="Add" /></td>
					</form>
				</tr>
				{% for res in fun.outliers %}
				 <tr>
					 <td style="color: red;">{{ res }}</td>
				 </tr>
				{% endfor %}
			{% endfor %}
			{% else %}
			<tr>
					<td style="text-align: right; font-weight:bold;" >{{ agent.name }} as {{ fun.function.name }} </td>
					<form action="{% url inline_agent_resource cluster_id=cluster.id agent_id=agent.id parent_id=0 %}" method="POST">
						{% csrf_token %}
						{{ fun.agent_resource_form.agent_function_id }}
						<td>
							{{ fun.agent_resource_form.role }}&nbsp;
							{{ fun.agent_resource_form.name }}
						</td>					
						<td>{{ fun.agent_resource_form.quantity }}</td>
						<td>{{ fun.agent_resource_form.value }}</td>
						<td><input type="submit" name="submit" value="Add" /></td>
					</form>
				</tr>
			{% endif %}
		{% endfor %}
	{% else %}
		<tr>
			<td>
				To participate in a Cluster, an Agent must perform at least one Cluster Function.
			</td>
		</tr>
	{% endif %}

</table>
</div>
<div style="float:left; margin-left:1em;">	
	<form action="." method="POST">
		{% csrf_token %}
		<table>
			<tr>
				<td>Address:</td>					
				<td>{{ agent_form.address }}</td>
				{{ agent_form.latitude }}
				{{ agent_form.longitude }}
			</tr>
			<tr>
				<td>&nbsp;</td>
				<td><input type="submit" name="submit_address" value="Change address" /></td>
			</tr>
		</table>
	</form>
	<div id="map_canvas" style="width: 400px; height: 300px;"></div>
</div>
	
<div style="clear:both;"></div>
	
</div>

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

<script type="text/javascript"
      src="http://maps.googleapis.com/maps/api/js?key={{ map_key }}&sensor=false">
</script>

  <link rel="stylesheet" href="/site_media/css/jquery.autocomplete.css" type="text/css" />
  <script type="text/javascript" src="/site_media/scripts/jquery.bgiframe.min.js"></script>

  <script type="text/javascript" src="/site_media/scripts/jquery.autocomplete.js"></script>


<script>
	
function html_unescape(text) {
    // Unescape a string that was escaped using django.utils.html.escape.
    text = text.replace(/&lt;/g, '<');
    text = text.replace(/&gt;/g, '>');
    text = text.replace(/&quot;/g, '"');
    text = text.replace(/&#39;/g, "'");
    text = text.replace(/&amp;/g, '&');
    return text;
}
	
var resourceNames = html_unescape("{{ resource_names }}").split("~");
var functionNames = html_unescape("{{ function_names }}").split("~");

var geocoder;
var map;
	
  function initialize() {
    geocoder = new google.maps.Geocoder();
    var latlng = new google.maps.LatLng(-34.397, 150.644);
    var myOptions = {
      center: new google.maps.LatLng({{ map_center }}),
      zoom: {{ zoom_level }},
      mapTypeId: google.maps.MapTypeId.ROADMAP
    }
    map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
  }

  function codeAddress() {
    var address = document.getElementById("id_address").value;
    geocoder.geocode( { 'address': address}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
		var loc = results[0].geometry.location;
		var lat = loc.lat()
		var lng = loc.lng();
		$("#id_latitude").val(lat);
		$("#id_longitude").val(lng);
        map.setCenter(loc);
        var marker = new google.maps.Marker({
            map: map,
            position: loc
        });
      } else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    });
  }
	
$(document).ready(function(){
	initialize();
	codeAddress();
	$("#id_address").blur(codeAddress);
	$(".resource-name").autocomplete(resourceNames, {matchContains: true});
	$(".function-name").autocomplete(functionNames, {matchContains: true});
	
	$(".quantity").blur(function() 
		{
			var quantity = this.value;
			var intQuantity = parseInt(quantity);
			if ($.isNumeric(quantity))
			{
				if (intQuantity == parseFloat(quantity))
				{
					var id = this.id;
					$.post("{% url change_agent_function_resource_amount %}",  { id: id, quantity: quantity });
				}
				else
				{
					alert(quantity + " must be an integer");
					this.value = intQuantity;
				}
			}
			else
			{
				alert(quantity + " is not a number");
				this.value = intQuantity;
			}
		});
	
		$(".value").blur(function() 
		{
			var quantity = this.value;
			var intQuantity = parseInt(quantity);
			if ($.isNumeric(quantity))
			{
				if (intQuantity == parseFloat(quantity))
				{
					var id = this.id;
					$.post("{% url change_agent_function_resource_value %}",  { id: id, value: quantity });
				}
				else
				{
					alert(quantity + " must be an integer");
					this.value = intQuantity;
				}
			}
			else
			{
				alert(quantity + " is not a number");
				this.value = intQuantity;
			}
		});
	
	$(document).ajaxSend(function(event, xhr, settings) {
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    function sameOrigin(url) {
        // url could be relative or scheme relative or absolute
        var host = document.location.host; // host + port
        var protocol = document.location.protocol;
        var sr_origin = '//' + host;
        var origin = protocol + sr_origin;
        // Allow absolute or scheme relative URLs to same origin
        return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
            (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
            // or any other URL that isn't scheme relative or absolute i.e relative.
            !(/^(\/\/|http:|https:).*/.test(url));
    }
    function safeMethod(method) {
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    if (!safeMethod(settings.type) && sameOrigin(settings.url)) {
        xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
    }
	});
	
});

 </script>
{% endblock %}
